#!/usr/bin/env groovy

/*
 *  Copyright (c) 2019-2021, Arm Limited, All Rights Reserved
 *  SPDX-License-Identifier: Apache-2.0
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may
 *  not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 *  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 *  This file is part of Mbed TLS (https://www.trustedfirmware.org/projects/mbed-tls/)
 */

/*
 * This script takes the following parameters:
 *
 * Repos and branches
 *  - TARGET_REPO
 *      Tells the parametrized job to behave like a PR targeting the specified repo.
 *      At the moment, it affects two things in PR jobs:
 *        - TF-PSA-Crypto all.sh components are skipped if set to 'mbedtls'
 *        - API-ABI-Check selects which repo to use based on the TARGET_REPO setting.
 *          (selecting 'mbedtls-framework' disables the test)
 *      Possible values:
 *        - mbedtls
 *        - TF-PSA-Crypto
 *        - mbedtls-framework
 *  - CHANGE_TARGET
 *      a commit-ish (commit/branch/tag/etc.) in TARGET_REPO that API-ABI-Check compares against
 *  - MBED_TLS_REPO
 *  - MBED_TLS_BRANCH
 *  - FRAMEWORK_REPO
 *  - FRAMEWORK_BRANCH
 *  - TF_PSA_CRYPTO_REPO
 *  - TF_PSA_CRYPTO_BRANCH
 *
 * Test options
 *  - RUN_ABI_CHECK
 *  - RUN_ALL_SH
 *  - RUN_BASIC_BUILD_TEST
 *  - RUN_FREEBSD
 *  - RUN_WINDOWS_TEST
 *
 * Other parameters
 *  - TEST_BRANCH
 *
 * Environment variables:
 *  - GIT_CREDENTIALS_ID
 *
 */

/* main job */
library identifier: 'mbedtls-test@master', retriever: legacySCM(scm)
String target_repo = env.TARGET_REPO ?: 'mbedtls'
environ.set_pr_environment(target_repo, false)
environ.set_pr_environment('foo', false)
mbedtls.run_pr_job(false, env.MBED_TLS_BRANCH, target_repo == 'mbedtls' ? '' : env.TF_PSA_CRYPTO_BRANCH)
